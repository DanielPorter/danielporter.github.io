<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Course Planner - Community College Hub</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Navbar -->
    <header>
      <nav class="navbar">
        <div class="nav-container">
          <a href="index.html" class="nav-logo">Community Hub</a>
          <ul class="nav-menu">
            <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
            <li class="nav-item"><a href="about.html" class="nav-link">About</a></li>
            <li class="nav-item"><a href="course-catalog.html" class="nav-link">Course Catalog</a></li>
            <li class="nav-item"><a href="course-planner.html" class="nav-link active">Course Planner</a></li>
          </ul>
        </div>
      </nav>
    </header>

    <main>
      <!-- Container with two columns: left for program selection, right for term timeline -->
      <div class="planner-container">
        <!-- Left Sidebar: Program Search & Selected Programs -->
        <aside class="program-sidebar">
          <h2>Select Program</h2>
          <input type="text" id="programSearch" placeholder="Search programs..." />
          <div id="programResults" class="program-results"></div>
          <h3>Opted-In Programs</h3>
          <div id="selectedPrograms" class="selected-programs"></div>
        </aside>

        <!-- Right Column: Term Timeline -->
        <section class="term-timeline">
          <h2>Your Course Plan</h2>
          <div id="plannerTimeline"></div>
        </section>
      </div>

      <section class="content">
        <button id="savePlanBtn">Save Plan</button>
      </section>
    </main>

    <footer>
      <p>&copy; 2025 Community College Hub</p>
    </footer>

    <script>
      // Generic function to load JSON data from a file.
      async function loadJSON(url) {
        const response = await fetch(url);
        return response.json();
      }
      
      // Global variables for plan and courses
      let plan = null;
      let coursesCatalog = [];
      let availablePrograms = [];
      let selectedPrograms = []; // Programs opted in by the user
      
      async function initPlanner() {
        // Load plan, courses catalog, and programs from their respective JSON files.
        plan = await loadJSON("plan.json");
        coursesCatalog = await loadJSON("courses.json");
        availablePrograms = await loadJSON("associates-requirements.json");
        
        renderPlanTimeline();
        setupDragAndDrop();
        renderProgramResults();
        renderSelectedPrograms();
        
        document.getElementById("savePlanBtn").addEventListener("click", () => {
          savePlan();
        });
        
        // Set up program search.
        document.getElementById("programSearch").addEventListener("input", (e) => {
          renderProgramResults(e.target.value);
        });
      }
      
      // Renders the term timeline (existing functionality)
      function renderPlanTimeline() {
        const container = document.getElementById("plannerTimeline");
        container.innerHTML = "";
        plan.semesters.forEach((semester, semesterIndex) => {
          const termCard = document.createElement("div");
          termCard.className = "term-card expanded";
          
          const header = document.createElement("div");
          header.className = "term-header";
          header.innerHTML = `<h2>${semester.semester}</h2>`;
          header.addEventListener("click", () => {
            termCard.classList.toggle("expanded");
            termBody.style.display = termCard.classList.contains("expanded") ? "block" : "none";
          });
          termCard.appendChild(header);
          
          const termBody = document.createElement("div");
          termBody.className = "term-body";
          termBody.style.display = "block";
          
          // Build table for courses in this term.
          const table = document.createElement("table");
          table.className = "term-table";
          table.innerHTML = `
            <thead>
              <tr>
                <th style="padding-right: 20px;">Course</th>
                <th style="padding-right: 20px;">Title</th>
                <th style="padding-right: 20px;">Units</th>
                <th style="padding-right: 20px;">Prerequisites</th>
                <th style="padding-right: 20px;">Corequisites</th>
                <th style="padding-right: 20px;">Notes</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          const tbody = table.querySelector("tbody");
          
          semester.courses.forEach((courseEntry, courseEntryIndex) => {
            const course = coursesCatalog.find(c => c.id === courseEntry.courseId);
            if (!course) return;
            
            const tr = document.createElement("tr");
            tr.className = "draggable-course";
            tr.setAttribute("draggable", "true");
            tr.dataset.semesterIndex = semesterIndex;
            tr.dataset.courseEntryIndex = courseEntryIndex;
            tr.dataset.courseId = course.id;
            
            const prereqStr = (course.prerequisites && course.prerequisites.length) ? course.prerequisites.join(", ") : "None";
            const coreqStr = (course.corequisites && course.corequisites.length) ? course.corequisites.join(", ") : "None";
            const missingPrereqs = getMissingPrerequisites(course, semesterIndex);
            const notesStr = missingPrereqs.length ? `Missing: ${missingPrereqs.join(", ")}` : courseEntry.customNotes || "";
            
            tr.innerHTML = `
              <td>${course.code}</td>
              <td>${course.title}</td>
              <td>${course.credits}</td>
              <td>${prereqStr}</td>
              <td>${coreqStr}</td>
              <td class="notes-cell">${notesStr}</td>
            `;
            
            // Set up drag events.
            tr.addEventListener("dragstart", (e) => {
              e.dataTransfer.setData("text/plain", JSON.stringify({
                sourceSemesterIndex: semesterIndex,
                courseEntryIndex: courseEntryIndex,
                courseId: course.id
              }));
            });
            
            tbody.appendChild(tr);
          });
          
          termBody.appendChild(table);
          termCard.appendChild(termBody);
          container.appendChild(termCard);
        });
      }
      
      // Checks missing prerequisites from previous terms.
      function getMissingPrerequisites(course, currentSemesterIndex) {
        let completed = [];
        for (let i = 0; i < currentSemesterIndex; i++) {
          plan.semesters[i].courses.forEach(entry => {
            const c = coursesCatalog.find(x => x.id === entry.courseId);
            if (c) completed.push(c.code);
          });
        }
        let missing = [];
        if (course.prerequisites && course.prerequisites.length > 0) {
          course.prerequisites.forEach(prereq => {
            if (!completed.includes(prereq)) missing.push(prereq);
          });
        }
        return missing;
      }
      
      // Set up drop targets for drag-and-drop in term tables.
      function setupDragAndDrop() {
        const termTables = document.querySelectorAll(".term-table tbody");
        termTables.forEach((tbody, semesterIndex) => {
          tbody.addEventListener("dragover", (e) => {
            e.preventDefault();
          });
          tbody.addEventListener("drop", (e) => {
            e.preventDefault();
            const data = JSON.parse(e.dataTransfer.getData("text/plain"));
            const targetSemesterIndex = parseInt(tbody.parentElement.parentElement.parentElement.dataset.semesterIndex || semesterIndex);
            if (data.sourceSemesterIndex === targetSemesterIndex) return; // Optionally ignore if same term.
            
            // Remove course from source semester.
            const sourceSemester = plan.semesters[data.sourceSemesterIndex];
            const [movedCourse] = sourceSemester.courses.splice(data.courseEntryIndex, 1);
            movedCourse.customNotes = "";
            // Add to target term.
            plan.semesters[targetSemesterIndex].courses.push(movedCourse);
            renderPlanTimeline();
          });
        });
      }
      
      // PROGRAMS SECTION: Program Search and Selection
      
      // Render available programs based on search query.
      function renderProgramResults(query = "") {
        const resultsDiv = document.getElementById("programResults");
        resultsDiv.innerHTML = "";
        const filtered = availablePrograms.filter(program =>
          program.program.toLowerCase().includes(query.toLowerCase())
        );
        filtered.forEach((program, index) => {
          const programDiv = document.createElement("div");
          programDiv.className = "program-result";
          programDiv.textContent = program.program;
          programDiv.addEventListener("click", () => {
            // Add program if not already selected.
            if (!selectedPrograms.some(p => p.program === program.program)) {
              selectedPrograms.push(program);
              renderSelectedPrograms();
            }
          });
          resultsDiv.appendChild(programDiv);
        });
      }
      
      // Render the list of opted-in programs.
      function renderSelectedPrograms() {
        const container = document.getElementById("selectedPrograms");
        container.innerHTML = "";
        selectedPrograms.forEach((program, index) => {
          const card = document.createElement("div");
          card.className = "program-card";
          // Header with program name and remove button.
          const header = document.createElement("div");
          header.className = "program-card-header";
          header.innerHTML = `<span>${program.program}</span> <button class="remove-btn" data-index="${index}">&times;</button>`;
          card.appendChild(header);
          // Body: list required courses and elective groups.
          const body = document.createElement("div");
          body.className = "program-card-body";
          // Required courses:
          if (program.requirements.coreCourses && program.requirements.coreCourses.length) {
            const coreList = program.requirements.coreCourses.map(core => {
              const course = coursesCatalog.find(c => c.id === core.courseId);
              return course ? course.code : "";
            }).filter(x => x);
            body.innerHTML += `<p><strong>Required:</strong> ${coreList.join(", ")}</p>`;
          }
          // Elective groups:
          if (program.requirements.electives && program.requirements.electives.length) {
            program.requirements.electives.forEach(group => {
              let instruction = "";
              if (group.minSelections && group.maxSelections && group.minSelections === group.maxSelections) {
                instruction = `Choose ${group.minSelections} courses`;
              } else if (group.minUnits) {
                instruction = `Choose ${group.minUnits} units`;
              } else {
                instruction = "Elective options:";
              }
              // Look up course codes for the options.
              const options = group.courseOptions.map(id => {
                const course = coursesCatalog.find(c => c.id === id);
                return course ? course.code : "";
              }).filter(x => x);
              body.innerHTML += `<p><strong>${instruction}:</strong> ${options.join(", ")}</p>`;
            });
          }
          card.appendChild(body);
          
          container.appendChild(card);
        });
        
        // Set up remove button events.
        const removeButtons = document.querySelectorAll(".remove-btn");
        removeButtons.forEach(btn => {
          btn.addEventListener("click", (e) => {
            const idx = parseInt(e.target.dataset.index);
            if (confirm(`Are you sure you want to remove the program "${selectedPrograms[idx].program}"?`)) {
              selectedPrograms.splice(idx, 1);
              renderSelectedPrograms();
            }
          });
        });
      }
      
      // Save the plan (for now, saving the plan JSON to localStorage).
      function savePlan() {
        plan.updatedAt = new Date().toISOString();
        localStorage.setItem("coursePlan", JSON.stringify(plan));
        alert("Plan saved successfully!");
      }
      
      initPlanner();
    </script>
  </body>
</html>
