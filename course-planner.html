<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Course Planner - Community College Hub</title>
    <link rel="stylesheet" href="style.css"/>
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="nav-container">
          <a href="index.html" class="nav-logo">Community Hub</a>
          <ul class="nav-menu">
            <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
            <li class="nav-item"><a href="about.html" class="nav-link">About</a></li>
            <li class="nav-item"><a href="course-catalog.html" class="nav-link">Course Catalog</a></li>
            <li class="nav-item"><a href="course-planner.html" class="nav-link active">Course Planner</a></li>
          </ul>
        </div>
      </nav>
    </header>

    <main>
      <section class="content">
        <h1>Course Planner</h1>
        <p>
          Below is a collapsible table showing your planned courses. 
          Click on any row to expand/collapse additional details.
        </p>

        <table id="planTable" class="plan-table">
          <thead>
            <tr>
              <th>Term</th>
              <th>Course</th>
              <th>Title</th>
              <th>Units</th>
              <th>Prereqs/Coreqs</th>
            </tr>
          </thead>
          <tbody id="planTableBody">
            <!-- Rows generated by JavaScript -->
          </tbody>
        </table>

        <button id="savePlanBtn">Save Plan</button>
      </section>
    </main>

    <footer>
      <p>&copy; 2025 Community College Hub</p>
    </footer>

    <script>
      // Simple function to load a JSON file
      async function loadJSON(url) {
        const response = await fetch(url);
        return response.json();
      }

      async function initPlanner() {
        // Load the plan, courses, and optionally requirements
        const plan = await loadJSON("plan.json");
        const coursesCatalog = await loadJSON("courses.json");
        // const requirements = await loadJSON("associates-requirements.json"); // if needed

        renderPlanTable(plan, coursesCatalog);

        document.getElementById("savePlanBtn").addEventListener("click", () => {
          savePlan(plan);
        });
      }

      function renderPlanTable(plan, coursesCatalog) {
        const tbody = document.getElementById("planTableBody");
        tbody.innerHTML = "";

        // Flatten the plan so each course in each semester is a row
        plan.semesters.forEach(semester => {
          const term = semester.semester; // e.g., "Spring 2026"

          semester.courses.forEach(courseEntry => {
            const course = coursesCatalog.find(c => c.id === courseEntry.courseId);
            if (!course) return; // skip if course not found

            // Build the table row
            const row = document.createElement("tr");
            row.className = "collapsible-row";

            // Prepare prerequisites/corequisites text
            let prereqText = "N/A";
            if (course.prerequisites && course.prerequisites.length > 0) {
              prereqText = "Prereqs: " + course.prerequisites.join(", ");
            }
            if (course.corequisites && course.corequisites.length > 0) {
              prereqText += prereqText === "N/A" ? "" : " | ";
              prereqText += "Coreqs: " + course.corequisites.join(", ");
            }
            if (prereqText === "N/A" && (course.prerequisites?.length > 0 || course.corequisites?.length > 0)) {
              // If there's partial data
              prereqText = prereqText.replace("N/A", "");
            }
            if (prereqText === "") prereqText = "N/A";

            row.innerHTML = `
              <td>${term}</td>
              <td>${course.code}</td>
              <td>${course.title}</td>
              <td>${course.credits}</td>
              <td>${prereqText}</td>
            `;

            // Hidden expanded row
            const expandRow = document.createElement("tr");
            expandRow.className = "expand-row";
            expandRow.style.display = "none"; // hidden by default

            // Add a cell spanning all columns
            const expandCell = document.createElement("td");
            expandCell.colSpan = 5;
            // Additional details: course description, custom notes, etc.
            let detailsHTML = `<p><strong>Description:</strong> ${course.description}</p>`;
            if (courseEntry.customNotes) {
              detailsHTML += `<p><strong>Notes:</strong> ${courseEntry.customNotes}</p>`;
            }
            expandCell.innerHTML = detailsHTML;
            expandRow.appendChild(expandCell);

            // Clicking the main row toggles the expandRow
            row.addEventListener("click", () => {
              expandRow.style.display = (expandRow.style.display === "none") ? "table-row" : "none";
            });

            // Insert both rows
            tbody.appendChild(row);
            tbody.appendChild(expandRow);
          });
        });
      }

      function savePlan(plan) {
        plan.updatedAt = new Date().toISOString();
        localStorage.setItem("coursePlan", JSON.stringify(plan));
        alert("Plan saved successfully!");
      }

      initPlanner();
    </script>
  </body>
</html>
